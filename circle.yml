machine:
  node:
    version: 4.2.1
  ruby:
    version: 2.2.3

dependencies:
  cache_directories:
    - "app/bower"

test:
  post:
    - npm run coverage-check
    - npm run coverage-report

general:
  artifacts:
    - "coverage"

deployment:
  production:
    branch: master
    commands:
      - git config --global user.email "dev-coop-bot@gmail.com"
      - git config --global user.name "dev-coop-bot"
      # build
      - $(npm bin)/gulp build
      # update changelog
      - gem install github_changelog_generator
      - github_changelog_generator $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME
      # force add ignored files
      - git add -f app/bower app/dist CHANGELOG.md dist docs/dist docs/index.html
      - if [[ -n $(git status --porcelain) ]]; then \
      -   echo "starting deploy, repo is dirty after build"
      -   git commit -n -m "deploy commit by $CIRCLE_USERNAME"
      -   git push origin master
      -   git push -f origin master:gh-pages
      - else
      -   echo "skipping deploy, repo is clean after build"
      - fi
