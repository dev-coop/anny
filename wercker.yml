box: shawnzhu/ruby-nodejs
build:
  steps:
    - npm-install
    - plasticine/bower-install@0.0.4
    - npm-test
    - script:
        name: coverage
        code: |
          npm run coverage-check
          npm run coverage-report
    - script:
        name: echo version information
        code: |
          echo "ruby: $(ruby -v)"
          echo "node: $(node -v)"
          echo "npm: $(npm -v)"
          echo "git: $(git --version)"
  after-steps:
      - slack-notifier:
          url: $SLACK_URL
          username: wercker
deploy:
  steps:
    - add-to-known_hosts:
        hostname: github.com
    - add-ssh-key:
        keyname: GITHUB_KEY
    - script:
        name: config git
        code: |
          git config --global user.email "dev-coop-bot@gmail.com"
          git config --global user.name "dev-coop-bot"
    - script:
        name: checkout full branch
        code: |
          git fetch --unshallow
          git checkout $WERCKER_GIT_BRANCH
    # Symlinked binaries in $(npm bin) are broken as they are copied from the
    # build process.  Remove and reinstall node_modules.
    # Nuke and reinstall bower components for good measure.
    - script:
        name: remove modules
        code: |
          rm -rf node_modules app/bower
    - npm-install
    - plasticine/bower-install@0.0.4
    - script:
        name: build
        code: |
          $(npm bin)/gulp build
    - script:
        name: generate changelog
        code: |
          if [[ -n $(which github_changelog_generator) ]]; then
            echo "...installing github_changelog_generator"
            sudo gem install github_changelog_generator
          fi
          github_changelog_generator $WERCKER_GIT_OWNER/$WERCKER_GIT_REPOSITORY
    - script:
        name: deploy
        code: |
          # force add ignored files
          git add -f app/bower app/dist CHANGELOG.md dist docs/dist docs/index.html
          if [[ -n $(git status --porcelain) ]]; then
            echo "starting deploy, repo is dirty after build"
            git commit -n -m "deploy commit by $WERCKER_STARTED_BY"
            git push $GIT_REMOTE $WERCKER_GIT_BRANCH
            git push -f $GIT_REMOTE $WERCKER_GIT_BRANCH:gh-pages
          else
            echo "skipping deploy, repo is clean after build"
          fi
    - script:
        name: echo version information
        code: |
          echo "ruby: $(ruby -v)"
          echo "node: $(node -v)"
          echo "npm: $(npm -v)"
          echo "git: $(git --version)"
  after-steps:
    - slack-notifier:
        url: $SLACK_URL
